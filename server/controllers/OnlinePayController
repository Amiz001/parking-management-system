
const OnlinePay = require("../models/OnlinePayModel");
const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);

// Create payment (save to DB + create Stripe payment intent)
const createPayment = async (req, res) => {
  try {
    const { username, vehicleType, quantity, amount, paymentMethod } = req.body;

    // Validate required fields
    if (!username || !vehicleType || !quantity || !amount || !paymentMethod) {
      return res.status(400).json({ message: "All fields are required" });
    }

    // 1️⃣ Save payment with status pending
    const payment = await OnlinePay.create({
      username,
      vehicleType,
      quantity,
      amount,
      paymentMethod,
      status: 'pending',
    });

    // 2️⃣ Create Stripe PaymentIntent
    const paymentIntent = await stripe.paymentIntents.create({
      amount: Math.round(amount * 100), // Stripe uses cents
      currency: 'lkr',
      metadata: {
        paymentId: payment._id.toString(),
        username,
      },
    });

    // Save Stripe paymentIntent ID
    payment.stripePaymentId = paymentIntent.id;
    await payment.save();

    res.status(201).json({
      paymentId: payment._id,
      clientSecret: paymentIntent.client_secret, // send this to frontend for Stripe checkout
    });

  } catch (err) {
    console.error(err.message);
    res.status(500).json({ message: err.message });
  }
};

// Update payment status after Stripe webhook
const updatePaymentStatus = async (req, res) => {
  try {
    const { paymentId, status } = req.body;
    if (!paymentId || !status) {
      return res.status(400).json({ message: "Payment ID and status are required" });
    }

    const payment = await OnlinePay.findByIdAndUpdate(paymentId, { status }, { new: true });
    res.json(payment);
  } catch (err) {
    console.error("Update Payment Status Error:", err.message);
    res.status(500).json({ message: err.message });
  }
};

module.exports = {
  createPayment,
  updatePaymentStatus,
};
