require('dotenv').config();
const OnlinePay = require('../models/OnlinePayModel'); 
const stripe = require('stripe')(process.env.VITE_STRIPE_SECRET_KEY);

// Create payment (save to DB + create Stripe payment intent)
const createPayment = async (req, res) => {
  try {
    const { username, vehicleType, quantity, amount, paymentMethod } = req.body;

    // Validate required fields
    if (!username || !vehicleType || !quantity || !amount || !paymentMethod) {
      return res.status(400).json({ message: "All fields are required" });
    }

    // 1️⃣ Save payment with status pending
    const payment = await OnlinePay.create({
      username,
      vehicleType,
      quantity,
      amount,
      paymentMethod,
      status: 'pending',
    });

    // 2️⃣ Create Stripe PaymentIntent
    const paymentIntent = await stripe.paymentIntents.create({
      amount: Math.round(amount * 100), // Stripe uses cents
      currency: 'lkr',
      metadata: {
        paymentId: payment._id.toString(),
        username,
      },
    });

    // Save Stripe paymentIntent ID
    payment.stripePaymentId = paymentIntent.id;
    await payment.save();

    res.status(201).json({
      paymentId: payment._id,
      clientSecret: paymentIntent.client_secret, 
    });

  } catch (err) {
    console.error(err.message);
    res.status(500).json({ message: err.message });
  }
};

// Update payment status after Stripe webhook
const updatePaymentStatus = async (req, res) => {
  try {
    const paymentId = req.params.id;
    const {status} = req.body;

    if (!status) {
      return res.status(400).json({ message: "Status is required" });
    }

    const payment = await OnlinePay.findByIdAndUpdate(paymentId, { status }, { new: true });
    res.json(payment);
  } catch (err) {
    console.error("Update Payment Status Error:", err.message);
    res.status(500).json({ message: err.message });
  }
};


const getAllPayments = async (req, res, next) => {
    try {
        const payment = await OnlinePay.find();
        if (!payment) {
            return res.status(404).json({ message: "No payments found." });
        }
        return res.status(200).json({ payment });
    } catch (err) {
        console.error(err);
        return res.status(500).json({ message: err.message }); 
    }
};

module.exports = {
  createPayment,
  updatePaymentStatus,
  getAllPayments,
};
